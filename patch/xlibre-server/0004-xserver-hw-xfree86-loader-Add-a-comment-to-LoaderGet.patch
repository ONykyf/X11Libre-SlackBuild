From 5667c899af16579ac48aa1db694ba254af0cb17d Mon Sep 17 00:00:00 2001
From: Oleh Nykyforchyn <oleh.nyk@gmail.com>
Date: Fri, 8 Aug 2025 18:37:11 +0300
Subject: [PATCH 4/4] xserver: hw/xfree86/loader: Add a comment to
 LoaderGetABIVersion

Signed-off-by: stefan11111 <stefan11111@shitposting.expert>
(original author)
Signed-off-by: Oleh Nykyforchyn <oleh.nyk@gmail.com>
---
 hw/xfree86/loader/loader.c | 34 ++++++++++++++++++++++++++++++++++
 1 file changed, 34 insertions(+)

diff --git a/hw/xfree86/loader/loader.c b/hw/xfree86/loader/loader.c
index baba403c3..19ed31a92 100644
--- a/hw/xfree86/loader/loader.c
+++ b/hw/xfree86/loader/loader.c
@@ -172,6 +172,40 @@ LoaderGetABIVersion(const char *abiclass)
         int version;
     } classes[] = {
         {ABI_CLASS_ANSIC, LoaderVersionInfo.ansicVersion},
+        /*
+         * XXX This is a hack. XXX
+         *
+         * The 470 nvidia driver only knows about an older abi
+         * where struct _Screen has an extra field.
+         *
+         * The modern nvidia drivers (e.g. 570) know about both
+         * abi's, and have different code paths for supporting
+         * both abi's.
+         *
+         * The modern nvidia drivers use this function to determine
+         * what video abi the X server uses, so it knows whether or
+         * not to use the newer abi, or the older abi, where
+         * struct _Screen has an extra field.
+         *
+         * The X server implements the older abi for struct _Screen,
+         * that the 470 driver knows, and we lie to the nvidia drivers
+         * that we use that older abi for the entire X server, so that
+         * modern nvidia drivers know to use the code path for supporting
+         * this older abi.
+         *
+         * We lie to the nvidia driver and claim to have an older abi
+         * so that both modern and old nvidia drivers work.
+         *
+         * In the future, nvidia might remove the code path for supporting
+         * the old abi from it's DDX driver.
+         *
+         * When that happens, unless we want to add major hacks and
+         * complexity to the codebase, we will no longer be able to
+         * support both abi's at once.
+         *
+         * Therefore a configure option that switches between abi's
+         * is added.
+         */
 #ifdef LEGACY_NVIDIA_PADDING
         {ABI_CLASS_VIDEODRV, is_nvidia_proprietary ?
                              ABI_NVIDIA_VERSION : LoaderVersionInfo.videodrvVersion},
-- 
2.47.1

